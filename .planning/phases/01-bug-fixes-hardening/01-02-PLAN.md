---
phase: 01-bug-fixes-hardening
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - app/admin/messages/actions.ts
  - app/favicon.ico
autonomous: true
requirements:
  - FIX-01
  - SITE-01

must_haves:
  truths:
    - "L'admin peut supprimer un message depuis /admin/messages sans erreur PERMISSION_DENIED"
    - "Le favicon apparaît dans l'onglet du navigateur sur toutes les pages"
    - "Un utilisateur non-admin reçoit une erreur 'Permission refusée' s'il tente de supprimer un message"
    - "Un utilisateur avec un token expiré reçoit une erreur explicite (pas un crash)"
  artifacts:
    - path: "app/admin/messages/actions.ts"
      provides: "Server Action deleteMessage using Admin SDK with auth verification"
      contains: "adminDb"
    - path: "app/favicon.ico"
      provides: "Browser tab icon for all pages"
  key_links:
    - from: "app/admin/messages/actions.ts"
      to: "lib/firebase-admin.ts"
      via: "imports adminDb and adminAuth"
      pattern: "import.*adminDb.*adminAuth.*firebase-admin"
    - from: "app/admin/messages/actions.ts"
      to: "Firestore users/{uid} document"
      via: "reads role field to verify admin permission"
      pattern: "role.*admin"
    - from: "app/admin/messages/actions.ts"
      to: "auth-token cookie"
      via: "reads cookie to verify authentication"
      pattern: "cookies.*auth-token"
---

<objective>
Fix the deleteMessage Server Action to use Firebase Admin SDK instead of client SDK, and add the missing favicon.

Purpose: Eliminate the PERMISSION_DENIED error when admin deletes messages (client SDK has no auth context in Server Actions). Add browser tab icon for professional appearance.
Output: Working admin message deletion and visible favicon.
</objective>

<execution_context>
@C:/Users/Samuel/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bug-fixes-hardening/01-RESEARCH.md
@.planning/phases/01-bug-fixes-hardening/01-01-SUMMARY.md

@app/admin/messages/actions.ts
@lib/firebase-admin.ts
@lib/auth/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace client SDK with Admin SDK in deleteMessage Server Action</name>
  <files>app/admin/messages/actions.ts</files>
  <action>
Rewrite the `deleteMessage` function in `app/admin/messages/actions.ts`. The current implementation uses `deleteDoc` from `firebase/firestore` (client SDK) which has no auth context in Server Actions, causing PERMISSION_DENIED.

Replace with Admin SDK pattern:

1. Remove imports of `deleteDoc`, `doc` from `firebase/firestore` and `firestore` from `@/lib/firebase` (if they were only used for delete)
2. Add imports: `import { adminAuth, adminDb } from '@/lib/firebase-admin'` and `import { cookies } from 'next/headers'` and `import { revalidatePath } from 'next/cache'`
3. Implement the function:

```typescript
export async function deleteMessage(messageId: string) {
  // Guard: Admin SDK must be configured
  if (!adminDb || !adminAuth) {
    return { success: false, error: 'Firebase Admin non configuré' };
  }

  // Step 1: Get auth token from cookie
  const cookieStore = await cookies();
  const token = cookieStore.get('auth-token')?.value;
  if (!token) {
    return { success: false, error: 'Non authentifié' };
  }

  // Step 2: Verify token (handles expiry gracefully)
  let uid: string;
  try {
    const decoded = await adminAuth.verifyIdToken(token);
    uid = decoded.uid;
  } catch {
    return { success: false, error: 'Session expirée, veuillez vous reconnecter' };
  }

  // Step 3: Verify caller is admin (uses unified role field from Plan 01-01)
  const userSnap = await adminDb.collection('users').doc(uid).get();
  if (userSnap.data()?.role !== 'admin') {
    return { success: false, error: 'Permission refusée' };
  }

  // Step 4: Delete message
  try {
    await adminDb.collection('messages').doc(messageId).delete();
    revalidatePath('/messages');
    revalidatePath('/');
    return { success: true };
  } catch (error) {
    console.error('Erreur suppression message:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Erreur inconnue',
    };
  }
}
```

IMPORTANT: Check if there are other exported functions in this file that use client SDK imports. If so, only remove the imports that are no longer needed. If other functions still need client SDK, keep those imports.

Also check `lib/firebase-admin.ts` to confirm that `adminAuth` and `adminDb` are exported and understand their types (they may be `undefined` if env vars are missing — the null check at the top handles this).

Note on `cookies()`: In Next.js 14+, `cookies()` may need to be awaited depending on the version. Check the existing usage in `lib/auth/actions.ts` to match the project's pattern (await or not).
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in app/admin/messages/actions.ts.
Grep for `deleteDoc` in app/admin/messages/actions.ts — should not appear.
Grep for `adminDb` in app/admin/messages/actions.ts — should appear.
Grep for `auth-token` in app/admin/messages/actions.ts — should appear (cookie verification).
  </verify>
  <done>deleteMessage uses Admin SDK with proper auth verification. Client SDK deleteDoc is removed. Token expiry returns a user-friendly error. Non-admin users are rejected. The PERMISSION_DENIED error is eliminated.</done>
</task>

<task type="auto">
  <name>Task 2: Add favicon.ico to the app directory</name>
  <files>app/favicon.ico</files>
  <action>
Create a favicon.ico file at `app/favicon.ico`. Next.js 14 App Router automatically serves files named `favicon.ico` in the `app/` directory.

Generate a simple, professional favicon:
- Use a simple design appropriate for a church website (a cross, or the letters "EPLS", or a simple geometric shape)
- Size: 32x32 pixels minimum, ideally multi-resolution ICO (16x16, 32x32, 48x48)
- If generating programmatically is not feasible, create a minimal valid ICO file using a base64-encoded template of a simple blue/purple icon (matching the site's primary color theme)

Alternative approach if ICO generation is complex: Create an `app/icon.png` file instead (Next.js 14 also supports PNG favicons in the app directory). A 32x32 PNG is simpler to generate.

Check `app/layout.tsx` to see if there is any `icons` metadata configuration. If not, no metadata changes are needed — Next.js serves the favicon automatically.
  </action>
  <verify>
Confirm file exists: `ls app/favicon.ico` or `ls app/icon.png`
Check file size is > 0 bytes: `wc -c app/favicon.ico` or `wc -c app/icon.png`
Run `npm run build` (or `npx next build`) to confirm no build errors related to the favicon.
  </verify>
  <done>A favicon file exists in app/ directory. Next.js serves it automatically. The browser tab shows an icon on all pages.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `grep -r "deleteDoc" app/admin/messages/` — no client SDK deleteDoc
3. `grep -r "adminDb" app/admin/messages/actions.ts` — Admin SDK is used
4. `ls app/favicon.ico || ls app/icon.png` — favicon file exists
5. `npm run build` — full build passes
</verification>

<success_criteria>
- deleteMessage Server Action uses Admin SDK with cookie-based auth verification (FIX-01 complete)
- Token expiry is handled gracefully with user-friendly error message
- Non-admin users are rejected with "Permission refusée"
- Favicon file exists in app/ directory and is served by Next.js (SITE-01 complete)
- Full build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes-hardening/01-02-SUMMARY.md`
</output>
