---
phase: 01-bug-fixes-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/firebase-helpers.ts
  - lib/firebase-utils.ts
  - hooks/use-user-data.tsx
  - types/index.ts
  - firestore.rules
autonomous: true
requirements:
  - FIX-02
  - FIX-03

must_haves:
  truths:
    - "Un nouvel utilisateur peut créer son profil sans erreur (setDoc fonctionne sur document inexistant)"
    - "Chaque document Firestore users/{uid} n'a qu'un seul champ de rôle (role) sans conflit avec isAdmin"
    - "Le hook useUserData dérive isAdmin depuis le champ role (pas de lecture directe de isAdmin)"
    - "Les règles Firestore vérifient role == 'admin' au lieu de isAdmin == true"
  artifacts:
    - path: "lib/firebase-helpers.ts"
      provides: "Canonical saveUserProfile using setDoc with merge, unified UserProfile type with role field only"
      contains: "setDoc"
    - path: "lib/firebase-utils.ts"
      provides: "Fixed saveUserProfile using setDoc with merge (or deprecated)"
      contains: "setDoc"
    - path: "hooks/use-user-data.tsx"
      provides: "Role-based isAdmin derivation"
      contains: "role === 'admin'"
    - path: "types/index.ts"
      provides: "User interface with role field, no isAdmin stored field"
      contains: "role"
    - path: "firestore.rules"
      provides: "isAdmin() function checking role field with transition support"
      contains: "data.role == 'admin'"
  key_links:
    - from: "hooks/use-user-data.tsx"
      to: "Firestore users/{uid} document"
      via: "onSnapshot reads role field and derives isAdmin"
      pattern: "role.*admin"
    - from: "firestore.rules"
      to: "Firestore users/{uid} document"
      via: "isAdmin() helper reads role field"
      pattern: "data\\.role == 'admin'"
    - from: "lib/firebase-helpers.ts"
      to: "Firestore users/{uid} document"
      via: "setDoc with merge writes role field"
      pattern: "setDoc.*merge.*true"
---

<objective>
Fix the saveUserProfile bug (setDoc with merge instead of updateDoc) and unify the role system across the codebase (single `role` field, no more `isAdmin` boolean).

Purpose: Eliminate the "No document to update" error for new users and prevent role field conflicts that cause permission logic to fail silently.
Output: Consistent role model across types, hooks, helpers, and Firestore rules.
</objective>

<execution_context>
@C:/Users/Samuel/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bug-fixes-hardening/01-RESEARCH.md

@lib/firebase-helpers.ts
@lib/firebase-utils.ts
@hooks/use-user-data.tsx
@types/index.ts
@firestore.rules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix saveUserProfile in both files to use setDoc with merge</name>
  <files>lib/firebase-helpers.ts, lib/firebase-utils.ts</files>
  <action>
In `lib/firebase-helpers.ts`, find the `saveUserProfile` function. Replace `updateDoc(userRef, ...)` with `setDoc(userRef, ..., { merge: true })`. The function should:
1. Get a reference to `doc(db, 'users', user.uid)`
2. Call `getDoc(userRef)` to check existence
3. Call `setDoc(userRef, { uid, email, displayName, photoURL, role: additionalData?.role ?? 'member', updatedAt: serverTimestamp(), ...(snap.exists() ? {} : { createdAt: serverTimestamp() }) }, { merge: true })`
4. Import `setDoc` and `getDoc` from `firebase/firestore` (add to existing imports, remove `updateDoc` if no longer used elsewhere in the file)

In `lib/firebase-utils.ts`, find the duplicate `saveUserProfile` function. Apply the exact same fix (replace `updateDoc` with `setDoc + merge`). Add a deprecation comment: `/** @deprecated Use saveUserProfile from lib/firebase-helpers.ts instead */`

First grep for all imports of `saveUserProfile` across the codebase to understand which version is actually used at call sites. Document findings in the summary.

Do NOT change the function signature or return type — only the internal implementation.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors related to saveUserProfile or setDoc.
Grep for `updateDoc` in both files — should no longer appear in saveUserProfile functions (may still appear in other functions in the same file).
  </verify>
  <done>Both saveUserProfile implementations use setDoc with merge. A new user profile can be created without "No document to update" error. Existing profiles are updated without overwriting createdAt.</done>
</task>

<task type="auto">
  <name>Task 2: Unify role system across types, hooks, and Firestore rules</name>
  <files>types/index.ts, hooks/use-user-data.tsx, firestore.rules, lib/firebase-helpers.ts</files>
  <action>
**types/index.ts:**
Find the `User` interface. Remove `isAdmin?: boolean` field if present. Remove `roles: string[]` if present. Ensure a `role: 'admin' | 'member' | 'visitor'` field exists (or add it). Keep any other fields intact.

Also find/update the `UserProfile` type in `lib/firebase-helpers.ts` if it defines role-related fields — align with the same `role: 'admin' | 'member' | 'visitor'` pattern.

**hooks/use-user-data.tsx:**
Find where `isAdmin` is set/computed. Currently it reads `data.isAdmin === true` from the Firestore document. Change it to derive from `role`:
- In the onSnapshot callback where user data is read, set `role: (data.role as string) ?? 'member'`
- Derive `isAdmin` as `role === 'admin'` (either in useMemo or inline)
- Do NOT read `data.isAdmin` from Firestore anymore
- Ensure the returned `isAdmin` value is still available to consumers (it should be derived, not stored)

**firestore.rules:**
Find the `isAdmin()` function. Currently it checks `data.isAdmin == true`. Update to:
```
function isAdmin() {
  return request.auth != null &&
    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true);
}
```
This transition rule supports both old (`isAdmin: true`) and new (`role: 'admin'`) documents. Add a comment: `// TRANSITION: remove isAdmin check after all admin docs have role field set`

**lib/firebase-helpers.ts:**
In the `saveUserProfile` function (already fixed in Task 1), ensure it writes `role` and does NOT write `isAdmin`. If there is any code that sets `isAdmin: true` when creating admin profiles, remove it and set `role: 'admin'` instead.

Search the entire codebase for any other places that write `isAdmin` to Firestore and update them to write `role` instead.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
Grep for `isAdmin.*true` in all .ts/.tsx files — should only appear in the transition Firestore rule and possibly in derived computations (not as a stored field being written).
Grep for `data.isAdmin` in hooks/use-user-data.tsx — should no longer appear.
  </verify>
  <done>The codebase uses a single `role` field for authorization. `isAdmin` is derived in application code, never stored. Firestore rules support both old and new format during transition. The User type has `role` without `isAdmin` as a stored field.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `grep -r "updateDoc" lib/firebase-helpers.ts lib/firebase-utils.ts` — no updateDoc in saveUserProfile functions
3. `grep -r "data\.isAdmin" hooks/` — no direct reads of isAdmin from Firestore data
4. `grep "role" types/index.ts` — User interface has role field
5. `grep "data.role" firestore.rules` — isAdmin() checks role field
</verification>

<success_criteria>
- Both saveUserProfile functions use setDoc with merge (FIX-02 complete)
- Single role field across types, hooks, helpers, and rules (FIX-03 complete)
- TypeScript compiles without errors
- Firestore rules have transition support for existing isAdmin docs
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes-hardening/01-01-SUMMARY.md`
</output>
