---
phase: 01-bug-fixes-hardening
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/favicon.ico
  - app/layout.tsx
  - hooks/use-user-data.tsx
  - lib/firebase-helpers.ts
autonomous: false
requirements:
  - FIX-03
  - SITE-01
gap_closure: true

must_haves:
  truths:
    - "Le favicon de l'utilisateur (téléchargement.png) apparaît dans l'onglet du navigateur"
    - "Un document Firestore avec role: 'Membre' est normalisé en 'member' à la lecture dans l'application"
    - "Un nouveau profil sauvegardé via saveUserProfile ne contient pas de champ isAdmin"
  artifacts:
    - path: "app/favicon.ico"
      provides: "Favicon réel de l'utilisateur (copie de téléchargement.png)"
    - path: "app/layout.tsx"
      provides: "Déclaration icons dans metadata pour forcer la découverte navigateur"
      contains: "icons"
    - path: "hooks/use-user-data.tsx"
      provides: "Fonction normalizeRole qui convertit 'Membre' -> 'member', 'Admin' -> 'admin'"
      contains: "normalizeRole"
    - path: "lib/firebase-helpers.ts"
      provides: "saveUserProfile supprime le champ isAdmin lors de la sauvegarde"
      contains: "deleteField"
  key_links:
    - from: "hooks/use-user-data.tsx"
      to: "Firestore data.role"
      via: "normalizeRole(data.role) au lieu de cast TypeScript direct"
      pattern: "normalizeRole"
    - from: "lib/firebase-helpers.ts"
      to: "Firestore users/{uid}"
      via: "setDoc avec deleteField() sur isAdmin pour nettoyage lazy"
      pattern: "deleteField"
---

<objective>
Corriger l'affichage du favicon (remplacer le fichier programmatique par le vrai logo de l'eglise) et normaliser les valeurs de role dans Firestore (convertir 'Membre' vers 'member', supprimer isAdmin lors des sauvegardes).

Purpose: Le favicon actuel est un ICO genere programmatiquement (croix bleue) — l'utilisateur veut son propre fichier. Les documents Firestore existants ont role: 'Membre' (casse francaise) et certains ont encore isAdmin boolean. La normalisation cote lecture dans use-user-data.tsx garantit que l'app fonctionne correctement meme sans migration des documents existants. Le nettoyage lazy dans saveUserProfile supprime progressivement isAdmin.

Output: Favicon reel visible, roles normalises a la lecture, isAdmin elimine des nouveaux writes.
</objective>

<execution_context>
@C:/Users/Samuel/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bug-fixes-hardening/01-01-SUMMARY.md
@hooks/use-user-data.tsx
@lib/firebase-helpers.ts
@app/layout.tsx
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Remplacer app/favicon.ico par le fichier de l'utilisateur</name>
  <files>app/favicon.ico</files>
  <action>
    Cette tache requiert une action manuelle — Claude ne peut pas copier des fichiers depuis
    le dossier Downloads vers le projet sans interaction utilisateur.

    Copier le fichier C:\Users\Samuel\Downloads\telechargement.png comme app/favicon.ico.

    Etapes exactes:
    1. Ouvrir l'Explorateur Windows
    2. Naviguer vers C:\Users\Samuel\Downloads\
    3. Copier le fichier telechargement.png
    4. Naviguer vers le dossier du projet: c:\Users\Samuel\Documents\Perso\EPLS Dev Website\template-2\app\
    5. Coller le fichier et le renommer en favicon.ico
       (repondre "Oui" pour ecraser le fichier existant)

    Note: Les navigateurs modernes acceptent les PNG renommes en .ico. Next.js 14 App Router
    sert automatiquement app/favicon.ico a /favicon.ico avec les bons headers.
    Si le fichier telechargement.png n'est pas dans Downloads, chercher un fichier PNG
    avec le logo de l'eglise et l'utiliser.
  </action>
  <verify>
    ls -la app/favicon.ico
    Le fichier doit exister avec une taille superieure a 1000 bytes (c'est un vrai PNG, pas le ICO de 143 bytes genere precedemment).
  </verify>
  <done>app/favicon.ico remplace par le fichier PNG de l'utilisateur (taille > 1000 bytes).</done>
  <resume-signal>Tapez "done" une fois le fichier copie, ou "skip" si le fichier est introuvable</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Ajouter icons dans metadata de layout.tsx + normaliser role dans use-user-data.tsx + nettoyage isAdmin dans saveUserProfile</name>
  <files>
    app/layout.tsx
    hooks/use-user-data.tsx
    lib/firebase-helpers.ts
  </files>
  <action>
    ### 1. app/layout.tsx — Ajouter icons dans metadata

    Ajouter la propriete `icons` a l'objet metadata existant:

    ```typescript
    export const metadata: Metadata = {
      title: {
        template: "%s | EPLS - Eglise Protestante Libre de Strasbourg",
        default: "EPLS - Eglise Protestante Libre de Strasbourg",
      },
      description: "Site officiel de l'Eglise Protestante Libre de Strasbourg (EPLS)",
      keywords: ["eglise", "protestante", "libre", "strasbourg", "evangelique", "chretien", "foi", "EPLS"],
      authors: [{ name: "EPLS" }],
      creator: "EPLS",
      publisher: "EPLS",
      icons: {
        icon: "/favicon.ico",
        shortcut: "/favicon.ico",
      },
      openGraph: {
        // ... contenu existant inchange
      },
    }
    ```

    Conserver les vraies valeurs avec accents telles qu'elles sont dans le fichier — la version
    sans accents ci-dessus est seulement pour la lisibilite dans ce plan.

    ### 2. hooks/use-user-data.tsx — Ajouter normalizeRole

    Ajouter une fonction utilitaire normalizeRole AVANT la definition de useUserData:

    ```typescript
    /**
     * Normalise les valeurs de role depuis Firestore.
     * Les documents existants peuvent avoir 'Membre', 'Admin', 'Visiteur' (casse francaise).
     * Cette fonction convertit vers les valeurs canoniques attendues par le code applicatif.
     */
    function normalizeRole(raw: unknown): 'admin' | 'member' | 'visitor' {
      if (typeof raw !== 'string') return 'member'
      switch (raw.toLowerCase()) {
        case 'admin':
        case 'administrateur':
          return 'admin'
        case 'member':
        case 'membre':
          return 'member'
        case 'visitor':
        case 'visiteur':
          return 'visitor'
        default:
          return 'member'
      }
    }
    ```

    Puis dans le callback onSnapshot, remplacer:
    ```typescript
    role: (data.role as 'admin' | 'member' | 'visitor') ?? 'member',
    ```
    par:
    ```typescript
    role: normalizeRole(data.role),
    ```

    ### 3. lib/firebase-helpers.ts — Nettoyage lazy de isAdmin dans saveUserProfile

    Ajouter l'import de deleteField depuis firebase/firestore (sur la ligne d'import existante):
    ```typescript
    import { ..., deleteField } from "firebase/firestore"
    ```

    Dans l'objet passe a setDoc dans saveUserProfile, ajouter `isAdmin: deleteField()` pour
    supprimer le champ lors de chaque sauvegarde de profil:

    ```typescript
    await setDoc(
      userRef,
      {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName,
        photoURL: user.photoURL,
        role: additionalData?.role ?? 'member',
        isAdmin: deleteField(), // Nettoyage lazy — supprime l'ancien champ boolean
        updatedAt: serverTimestamp(),
        ...(userSnap.exists() ? {} : { createdAt: serverTimestamp() }),
        ...additionalData,
      },
      { merge: true }
    )
    ```

    Note: deleteField() avec merge:true supprime le champ isAdmin s'il existe,
    sans affecter les autres champs. Si isAdmin n'existe pas, l'operation est no-op.
  </action>
  <verify>
    grep -n "icons" app/layout.tsx
    grep -n "normalizeRole" hooks/use-user-data.tsx
    grep -n "deleteField" lib/firebase-helpers.ts
    npx tsc --noEmit 2>&1 | grep -E "use-user-data|firebase-helpers|layout" | head -10
  </verify>
  <done>
    - layout.tsx contient icons: { icon: "/favicon.ico", shortcut: "/favicon.ico" } dans metadata
    - use-user-data.tsx contient normalizeRole() et l'utilise dans onSnapshot callback
    - firebase-helpers.ts contient deleteField() dans l'appel setDoc de saveUserProfile
    - Aucune nouvelle erreur TypeScript dans ces trois fichiers
  </done>
</task>

</tasks>

<verification>
Apres les 2 taches:
1. `ls -la app/favicon.ico` — fichier present avec taille > 1000 bytes
2. `grep -n "icons" app/layout.tsx` — doit trouver la section icons
3. `grep -n "normalizeRole" hooks/use-user-data.tsx` — doit trouver la fonction et son usage
4. `grep -n "deleteField" lib/firebase-helpers.ts` — doit trouver l'import et l'usage dans setDoc
5. Test manuel: Recharger le site → favicon visible dans l'onglet
6. Test manuel: Connecter un compte avec role: 'Membre' → role normalise en 'member' dans l'app
</verification>

<success_criteria>
- favicon.ico de l'utilisateur visible dans l'onglet du navigateur sur toutes les pages
- Un utilisateur avec role: 'Membre' dans Firestore est traite comme 'member' dans l'app
- Apres saveUserProfile, le document Firestore n'a plus de champ isAdmin
- Aucune nouvelle erreur TypeScript dans les fichiers modifies
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes-hardening/01-04-SUMMARY.md`
</output>
