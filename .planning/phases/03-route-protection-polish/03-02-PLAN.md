---
phase: 03-route-protection-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/admin/images-site/page.tsx
  - scripts/seed-site-images.js
autonomous: false
requirements:
  - SITE-02

must_haves:
  truths:
    - "L'admin peut uploader une image via /admin/images-site sans erreur Firestore"
    - "L'image uploadée apparaît sur la page du site correspondante via DynamicImageBlock"
  artifacts:
    - path: "app/admin/images-site/page.tsx"
      provides: "Admin image upload using setDoc (not updateDoc) for robustness"
      contains: "setDoc"
    - path: "scripts/seed-site-images.js"
      provides: "Seed script for site_images collection"
  key_links:
    - from: "app/admin/images-site/page.tsx"
      to: "site_images collection in Firestore"
      via: "setDoc with merge:true to create or update"
      pattern: "setDoc"
    - from: "components/ui/dynamic-image-block.tsx"
      to: "site_images collection in Firestore"
      via: "onSnapshot listener"
      pattern: "onSnapshot"
---

<objective>
Fix the admin images-site upload to work without pre-seeded Firestore documents and verify the end-to-end image pipeline (admin upload -> site display via DynamicImageBlock).

Purpose: Ensure images uploaded via /admin/images-site actually appear on the corresponding site pages, completing the content management pipeline.
Output: Robust admin upload (setDoc instead of updateDoc) + verified round-trip.
</objective>

<execution_context>
@C:/Users/Samuel/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-route-protection-polish/03-RESEARCH.md
@app/admin/images-site/page.tsx
@components/ui/dynamic-image-block.tsx
@scripts/seed-site-images.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix admin images-site to use setDoc with merge instead of updateDoc</name>
  <files>app/admin/images-site/page.tsx</files>
  <action>
The admin images-site page currently uses `updateDoc` (line 150 and line 186) which FAILS if the Firestore document doesn't exist yet. This makes the upload dependent on running the seed script first.

Fix by replacing `updateDoc` with `setDoc` + `{ merge: true }` in two places:

1. **Import change:** Replace `updateDoc` with `setDoc` in the firebase/firestore import. Add `{ merge: true }` as the third argument.
   - Change: `import { ..., updateDoc, ... }` → `import { ..., setDoc, ... }`

2. **Line ~150 (handleFileSelect / zone update):**
   - Before: `await updateDoc(doc(firestore, 'site_images', zone), { ... })`
   - After: `await setDoc(doc(firestore, 'site_images', zone), { ... }, { merge: true })`

3. **Line ~186 (image deletion/reset):**
   - Before: `await updateDoc(doc(firestore, 'site_images', image.id), { ... })`
   - After: `await setDoc(doc(firestore, 'site_images', image.id), { ... }, { merge: true })`

This makes the admin upload work regardless of whether the seed script was run. `setDoc` with `merge: true` creates the document if it doesn't exist, or updates if it does — identical behavior to the seed script's `set()` with `{ merge: true }`.

Keep the seed script as-is — it's still useful for initializing all zones with defaults, but is no longer a hard prerequisite.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no type errors.
2. Grep for `setDoc` in admin/images-site/page.tsx — must appear.
3. Grep for `updateDoc` in admin/images-site/page.tsx — must NOT appear.
4. Run `npm run build` — build succeeds.
  </verify>
  <done>Admin images-site page uses setDoc with merge:true for all Firestore writes, making it work without pre-seeded documents.</done>
</task>

<task type="checkpoint:human-verify" gate="soft">
  <name>Task 2: Verify image upload round-trip in production</name>
  <action>Push to GitHub to trigger Vercel deploy. Then ask user to verify the image upload round-trip:
1. Log in as admin on the production site.
2. Navigate to /admin/images-site.
3. Pick any zone (e.g. "cultes-hero") and upload an image.
4. Confirm: no Firestore error appears, upload succeeds with a success toast.
5. Navigate to the corresponding page (e.g. /culte) where that zone's DynamicImageBlock is used.
6. Confirm: the uploaded image appears (not the fallback placeholder).
7. If images do NOT appear: check Firestore console for the `site_images` collection — documents should exist with `imageUrl` field populated.</action>
  <verify>User confirms images appear on the site after upload via admin panel.</verify>
  <done>Image upload round-trip works end-to-end: admin uploads image, it appears on the corresponding site page.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes.
2. `npm run build` succeeds.
3. Admin images-site page uses `setDoc` with `merge: true` instead of `updateDoc`.
4. Human confirms image upload round-trip works end-to-end.
</verification>

<success_criteria>
- Admin can upload images without Firestore errors even when site_images documents don't pre-exist.
- Uploaded images appear on corresponding site pages via DynamicImageBlock.
- Build passes without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/03-route-protection-polish/03-02-SUMMARY.md`
</output>
